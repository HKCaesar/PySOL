
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gsdtools.ras2vec &mdash; GSDView Open Edition Home Page</title>
    <link rel="stylesheet" href="../../_static/sourceforge.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/logo.ico"/>
    <link rel="top" title="GSDView Open Edition Home Page" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    
        
    
    
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li><a href="../../index.html">GSDView</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for gsdtools.ras2vec</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>

<span class="c">### Copyright (C) 2008-2011 Antonio Valentino &lt;a_valentino@users.sf.net&gt;</span>

<span class="c">### This file is part of GSDView.</span>

<span class="c">### GSDView is free software; you can redistribute it and/or modify</span>
<span class="c">### it under the terms of the GNU General Public License as published by</span>
<span class="c">### the Free Software Foundation; either version 2 of the License, or</span>
<span class="c">### (at your option) any later version.</span>

<span class="c">### GSDView is distributed in the hope that it will be useful,</span>
<span class="c">### but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">### MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">### GNU General Public License for more details.</span>

<span class="c">### You should have received a copy of the GNU General Public License</span>
<span class="c">### along with GSDView; if not, write to the Free Software</span>
<span class="c">### Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA.</span>


<span class="sd">&#39;&#39;&#39;Generate a vector file containing the bounding box of raster data.</span>

<span class="sd">Take in input one or more raster datasets and generate a vector file</span>
<span class="sd">containing the bounding box polygon and, optionally, a GCP layer of</span>
<span class="sd">each input dataset.</span>

<span class="sd">Note: currently only the KML format is supported for output.</span>

<span class="sd">This program aims to be an improved and more flexible version of the</span>
<span class="sd">gdaltindex utility.</span>

<span class="sd">.. seealso: http://www.gdal.org/gdaltindex.html</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c"># @TODO:</span>
<span class="c">#</span>
<span class="c">#   * support more output formats</span>
<span class="c">#   * confogurable spatial reference system</span>
<span class="c">#   * configurable database field for path storage (see gdaltindex)</span>
<span class="c">#   * colors</span>
<span class="c">#   * filling (with transparency)</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span><span class="p">,</span> <span class="n">ogr</span><span class="p">,</span> <span class="n">osr</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Antonio Valentino &lt;a_valentino@users.sf.net&gt;&#39;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s">&#39;$Date: 2011-07-30 11:07:42 +0200 (sab, 30 lug 2011) $&#39;</span>
<span class="n">__revision__</span> <span class="o">=</span> <span class="s">&#39;$Revision: 971 $&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;EX_USAGE&#39;</span><span class="p">):</span>
    <span class="n">EX_USAGE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">EX_USAGE</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">EX_USAGE</span> <span class="o">=</span> <span class="mi">64</span>

<span class="n">DEFAULT_OGRDRIVER</span> <span class="o">=</span> <span class="s">&#39;KML&#39;</span>


<div class="viewcode-block" id="makesrs"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.makesrs">[docs]</a><span class="k">def</span> <span class="nf">makesrs</span><span class="p">(</span><span class="n">srs</span><span class="p">):</span>
    <span class="c"># @NOTE: KML by specification uses only a single projection, EPSG:4326</span>
    <span class="c">#        (a.k.a. WGS84)</span>

    <span class="k">if</span> <span class="n">srs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">SetWellKnownGeogCS</span><span class="p">(</span><span class="s">&#39;EPSG:4326&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">srs</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">srs</span>
        <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">SetFromUserInput</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">srs</span>

</div>
<div class="viewcode-block" id="create_box_layer"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.create_box_layer">[docs]</a><span class="k">def</span> <span class="nf">create_box_layer</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">srs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbUnknown</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">srs</span> <span class="o">=</span> <span class="n">makesrs</span><span class="p">(</span><span class="n">srs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">srs</span><span class="p">,</span> <span class="n">gtype</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;layer creation failed.&#39;</span><span class="p">)</span>

    <span class="c">#~ field = ogr.FieldDefn(&#39;Name&#39;, ogr.OFTString)</span>
    <span class="c">#~ layer.CreateField(field)</span>

    <span class="c">#~ field = ogr.FieldDefn(&#39;Description&#39;, ogr.OFTString)</span>
    <span class="c">#~ layer.CreateField(field)</span>

    <span class="k">return</span> <span class="n">layer</span>

</div>
<div class="viewcode-block" id="create_GCP_layer"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.create_GCP_layer">[docs]</a><span class="k">def</span> <span class="nf">create_GCP_layer</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">srs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gtype</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint25D</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">srs</span> <span class="o">=</span> <span class="n">makesrs</span><span class="p">(</span><span class="n">srs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">CreateLayer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">srs</span><span class="p">,</span> <span class="n">gtype</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;layer creation failed.&#39;</span><span class="p">)</span>

    <span class="c">#~ field = ogr.FieldDefn(&#39;Name&#39;, ogr.OFTString)</span>
    <span class="c">#~ layer.CreateField(field)</span>

    <span class="c">#~ field = ogr.FieldDefn(&#39;Description&#39;, ogr.OFTString)</span>
    <span class="c">#~ layer.CreateField(field)</span>

    <span class="c">#field = ogr.FieldDefn(&#39;X&#39;, ogr.OFTReal)</span>
    <span class="c">#layer.CreateField(field)</span>
    <span class="c">#</span>
    <span class="c">#field = ogr.FieldDefn(&#39;Y&#39;, ogr.OFTReal)</span>
    <span class="c">#layer.CreateField(field)</span>
    <span class="c">#</span>
    <span class="c">#field = ogr.FieldDefn(&#39;Z&#39;, ogr.OFTReal)</span>
    <span class="c">#layer.CreateField(field)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s">&#39;Pixel&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s">&#39;Line&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTReal</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s">&#39;Info&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTString</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">FieldDefn</span><span class="p">(</span><span class="s">&#39;Id&#39;</span><span class="p">,</span> <span class="n">ogr</span><span class="o">.</span><span class="n">OFTString</span><span class="p">)</span>
    <span class="n">layer</span><span class="o">.</span><span class="n">CreateField</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">layer</span>

</div>
<div class="viewcode-block" id="geographic_info"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.geographic_info">[docs]</a><span class="k">def</span> <span class="nf">geographic_info</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">srsout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># Read geotransform matrix and source reference system</span>
    <span class="n">srs</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">SpatialReference</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGCPCount</span><span class="p">():</span>
        <span class="n">gcps</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGCPs</span><span class="p">()</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetGCPProjection</span><span class="p">())</span>
        <span class="n">geomatrix</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GCPsToGeoTransform</span><span class="p">(</span><span class="n">gcps</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gcps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;no geographic info in &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span>
                                                        <span class="n">ds</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">())</span>
        <span class="n">srs</span><span class="o">.</span><span class="n">ImportFromWkt</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">())</span>
        <span class="n">geomatrix</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">geomatrix</span> <span class="o">==</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;no geographic info in &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">ds</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">())</span>

    <span class="c"># Set the target reference system</span>
    <span class="n">srsout</span> <span class="o">=</span> <span class="n">makesrs</span><span class="p">(</span><span class="n">srsout</span><span class="p">)</span>

    <span class="c"># Instantiate the coordinate transformer</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="n">osr</span><span class="o">.</span><span class="n">CoordinateTransformation</span><span class="p">(</span><span class="n">srs</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>

    <span class="c"># dataset corners setup</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span>
                                <span class="p">(</span><span class="mi">0</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
                                <span class="p">(</span><span class="mi">0</span><span class="p">,</span>                  <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">RasterYSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">RasterXSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))):</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pixel</span> <span class="o">+</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">line</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">pixel</span> <span class="o">+</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">line</span>

        <span class="c"># Shift to the center of the pixel</span>
        <span class="n">X</span> <span class="o">+=</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">Y</span> <span class="o">+=</span> <span class="n">geomatrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

        <span class="n">gcp</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GCP</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">corners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcp</span><span class="p">)</span>

    <span class="c"># convert GCPs to the targer srs</span>
    <span class="n">outgcps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">gcp</span> <span class="ow">in</span> <span class="n">gcps</span><span class="p">:</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">TransformPoint</span><span class="p">(</span><span class="n">gcp</span><span class="o">.</span><span class="n">GCPX</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPY</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPZ</span><span class="p">)</span>
        <span class="n">gcp</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GCP</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPPixel</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPLine</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Info</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
        <span class="n">outgcps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gcp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corners</span><span class="p">,</span> <span class="n">outgcps</span>

</div>
<div class="viewcode-block" id="export_bounding_box"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.export_bounding_box">[docs]</a><span class="k">def</span> <span class="nf">export_bounding_box</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">mark_corners</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c"># ring</span>
    <span class="n">ring</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbLinearRing</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gcp</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
        <span class="n">ring</span><span class="o">.</span><span class="n">AddPoint_2D</span><span class="p">(</span><span class="n">gcp</span><span class="o">.</span><span class="n">GCPX</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPY</span><span class="p">)</span>
    <span class="n">ring</span><span class="o">.</span><span class="n">CloseRings</span><span class="p">()</span>

    <span class="c"># polygon</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPolygon</span><span class="p">)</span>
    <span class="n">poly</span><span class="o">.</span><span class="n">AddGeometry</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>

    <span class="c"># feature</span>
    <span class="n">featurename</span> <span class="o">=</span> <span class="s">&#39;bounding box&#39;</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">GetName</span><span class="p">():</span>
        <span class="n">featurename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="n">featurename</span><span class="p">)</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Description&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">SetStyleString</span><span class="p">(</span><span class="s">&#39;BRUSH(fc:#FF000064);PEN(c:#FF0000)&#39;</span><span class="p">)</span>  <span class="c"># red filled</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;failed to create a new feature.&#39;</span><span class="p">)</span>
    <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mark_corners</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gcp</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint</span><span class="p">)</span>
            <span class="n">point</span><span class="o">.</span><span class="n">SetPoint_2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPX</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPY</span><span class="p">)</span>

            <span class="n">line</span><span class="p">,</span> <span class="n">pixel</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPLine</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPPixel</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;(</span><span class="si">%.1f</span><span class="s">, </span><span class="si">%.1f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pixel</span><span class="p">))</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Description&#39;</span><span class="p">,</span>
                             <span class="s">&#39;row = </span><span class="si">%.1f</span><span class="se">\n</span><span class="s">col = </span><span class="si">%.1f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pixel</span><span class="p">))</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">SetStyleString</span><span class="p">(</span><span class="s">&#39;SYMBOL(c:#FF0000)&#39;</span><span class="p">)</span>     <span class="c"># red</span>

            <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;failed to create a new feature.&#39;</span><span class="p">)</span>
            <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="export_gcps"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.export_gcps">[docs]</a><span class="k">def</span> <span class="nf">export_gcps</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">gcps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">gcp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gcps</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Id</span><span class="p">:</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Id</span>

        <span class="n">point</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Geometry</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">ogr</span><span class="o">.</span><span class="n">wkbPoint25D</span><span class="p">)</span>
        <span class="n">point</span><span class="o">.</span><span class="n">SetPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPX</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPY</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPZ</span><span class="p">)</span>

        <span class="n">feature</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;GCPs </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">id_</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Description&#39;</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>

        <span class="c">#feature.SetField(&#39;X&#39;, gcp.GCPX)</span>
        <span class="c">#feature.SetField(&#39;Y&#39;, gcp.GCPY)</span>
        <span class="c">#feature.SetField(&#39;Z&#39;, gcp.GCPZ)</span>

        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Pixel&#39;</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPPixel</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Line&#39;</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">GCPLine</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Info&#39;</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Info</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetField</span><span class="p">(</span><span class="s">&#39;Id&#39;</span><span class="p">,</span> <span class="n">gcp</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">SetGeometry</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;failed to create a new feature.&#39;</span><span class="p">)</span>
        <span class="n">feature</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="create_datasource"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.create_datasource">[docs]</a><span class="k">def</span> <span class="nf">create_datasource</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">drivername</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">drivername</span><span class="p">:</span>
        <span class="n">drivername</span> <span class="o">=</span> <span class="n">DEFAULT_OGRDRIVER</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">drivername</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">driver</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;unable to instantiate the &quot;</span><span class="si">%s</span><span class="s">&quot; driver.&#39;</span> <span class="o">%</span>
                                                                <span class="n">drivername</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;using &quot;</span><span class="si">%s</span><span class="s">&quot; driver.&#39;</span> <span class="o">%</span> <span class="n">drivername</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">CreateDataSource</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;creation of output file (&quot;</span><span class="si">%s</span><span class="s">&quot;) failed.&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;output file: &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>

</div>
<div class="viewcode-block" id="export_raster"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.export_raster">[docs]</a><span class="k">def</span> <span class="nf">export_raster</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">boxlayer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gcplayer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">srsout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">mark_corners</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">src</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;unable to open source dataset: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span>
                                                                    <span class="n">filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">create_datasource</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

    <span class="c"># Set the target reference system</span>
    <span class="n">srsout</span> <span class="o">=</span> <span class="n">makesrs</span><span class="p">(</span><span class="n">srsout</span><span class="p">)</span>

    <span class="c"># Instantiate the coordinate transformer</span>
    <span class="n">corners</span><span class="p">,</span> <span class="n">gcps</span> <span class="o">=</span> <span class="n">geographic_info</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>

    <span class="c"># Bounding box</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">GetDescription</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">boxlayer</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">boxlayer</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="n">boxlayername</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
        <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">create_box_layer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">boxlayername</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">boxlayer</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">boxlayer</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">boxlayername</span> <span class="o">=</span> <span class="n">boxlayer</span>
        <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">GetLayerByName</span><span class="p">(</span><span class="n">boxlayername</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">boxlayer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">create_box_layer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">boxlayername</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">boxlayer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;unable to create a new layer.&#39;</span><span class="p">)</span>

    <span class="n">export_bounding_box</span><span class="p">(</span><span class="n">boxlayer</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">mark_corners</span><span class="p">)</span>

    <span class="c"># GCPs</span>
    <span class="k">if</span> <span class="n">gcps</span> <span class="ow">and</span> <span class="n">gcplayer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gcplayer</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">gcplayername</span> <span class="o">=</span> <span class="s">&#39;gcps_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
            <span class="n">gcplayer</span> <span class="o">=</span> <span class="n">create_GCP_layer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">gcplayername</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gcplayer</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gcplayer</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">gcplayername</span> <span class="o">=</span> <span class="n">gcplayer</span>
            <span class="n">gcplayer</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">GetLayerByName</span><span class="p">(</span><span class="n">gcplayername</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gcplayer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">gcplayer</span> <span class="o">=</span> <span class="n">create_GCP_layer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">gcplayername</span><span class="p">,</span> <span class="n">srsout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gcplayer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;unable to create a new layer.&#39;</span><span class="p">)</span>

        <span class="n">export_gcps</span><span class="p">(</span><span class="n">gcplayer</span><span class="p">,</span> <span class="n">gcps</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">boxlayer</span><span class="p">,</span> <span class="n">gcplayer</span>

</div>
<div class="viewcode-block" id="compact_index"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.compact_index">[docs]</a><span class="k">def</span> <span class="nf">compact_index</span><span class="p">(</span><span class="n">srclist</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">create_datasource</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

    <span class="c"># Bounding box</span>
    <span class="n">boxlayername</span> <span class="o">=</span> <span class="s">&#39;index&#39;</span>

    <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">dst</span><span class="o">.</span><span class="n">GetLayerByName</span><span class="p">(</span><span class="n">boxlayername</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">boxlayer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">create_box_layer</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">boxlayername</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">srclist</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;adding &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unable to open source dataset: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">export_raster</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">boxlayer</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">mark_corners</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;no geographic info&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">subdatasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">subds</span> <span class="k">for</span> <span class="n">subds</span><span class="p">,</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">GetSubDatasets</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">subdatasets</span><span class="p">:</span>
            <span class="n">compact_index</span><span class="p">(</span><span class="n">subdatasets</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="raster_index"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.raster_index">[docs]</a><span class="k">def</span> <span class="nf">raster_index</span><span class="p">(</span><span class="n">srclist</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">gcplayer</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mark_corners</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">create_datasource</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

    <span class="c"># Bounding box</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">srclist</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;adding &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">src</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">src</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">src</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unable to open source dataset: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">export_raster</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">gcplayer</span><span class="p">,</span> <span class="n">mark_corners</span><span class="o">=</span><span class="n">mark_corners</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;no geographic info&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">subdatasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">subds</span> <span class="k">for</span> <span class="n">subds</span><span class="p">,</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">GetSubDatasets</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">subdatasets</span><span class="p">:</span>
            <span class="n">raster_index</span><span class="p">(</span><span class="n">subdatasets</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">gcplayer</span><span class="p">,</span> <span class="n">mark_corners</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="raster_tree_index"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.raster_tree_index">[docs]</a><span class="k">def</span> <span class="nf">raster_tree_index</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">boxlayer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">gcplayer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">mark_corners</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">create_datasource</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">PushErrorHandler</span><span class="p">(</span><span class="s">&#39;CPLQuietErrorHandler&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span>  <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">export_raster</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">boxlayer</span><span class="p">,</span> <span class="n">gcplayer</span><span class="p">,</span>
                              <span class="n">mark_corners</span><span class="o">=</span><span class="n">mark_corners</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="c">#logging.exception(str(e))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;skip &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;adding &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">gdal</span><span class="o">.</span><span class="n">PopErrorHandler</span><span class="p">()</span>


<span class="c">### Command line tool #########################################################</span></div>
<div class="viewcode-block" id="handlecmd"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.handlecmd">[docs]</a><span class="k">def</span> <span class="nf">handlecmd</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">optparse</span>

    <span class="c"># @NOTE: ogr.GeneralCmdLineProcessor is not available in GDAL 1.6.x</span>
    <span class="n">argv</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GeneralCmdLineProcessor</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span>
                        <span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog [options] OUTPUT INPUT [INPUT [...]]&#39;</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%%</span><span class="s">prog </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="c">#parser.add_option(&#39;-o&#39;, &#39;--outfile&#39;, type=&#39;str&#39;,</span>
    <span class="c">#                  help=&#39;output file name (default: generated)&#39;)</span>
    <span class="c">#parser.add_option(&#39;-f&#39;, &#39;--format&#39;, type=&#39;str&#39;, default=&#39;KML&#39;,</span>
    <span class="c">#                  help=&#39;output vector format (default: %default)&#39;)</span>
    <span class="c">#parser.add_option(&#39;-s&#39;, &#39;--t_srs&#39;, type=&#39;str&#39;, default=&#39;EPSG:4326&#39;</span>
    <span class="c">#                  help=&#39;target spatial reference system &#39;</span>
    <span class="c">#                       &#39;(default: %default)&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-g&#39;</span><span class="p">,</span> <span class="s">&#39;--gcps&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;generate an additional layer for GCPs &#39;</span>
                           <span class="s">&#39;(default: </span><span class="si">%d</span><span class="s">efault)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--corners&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;generate markers for bounding box corners &#39;</span>
                           <span class="s">&#39;(default: </span><span class="si">%d</span><span class="s">efault)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--abspath&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;store absolute path in bounding box feature &#39;</span>
                           <span class="s">&#39;description (default: </span><span class="si">%d</span><span class="s">efault)&#39;</span><span class="p">)</span>

    <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;at least two arguments are required.&#39;</span><span class="p">)</span>

    <span class="c">#~ if options.t_srs and options.format in (&#39;KML&#39;, &#39;LIBKML&#39;):</span>
        <span class="c">#~ epsg4326 = osr.SpatialReference()</span>
        <span class="c">#~ epsg4326.SetWellKnownGeogCS(&#39;EPSG:4326&#39;)</span>

        <span class="c">#~ tsrs = osr.SpatialReference()</span>
        <span class="c">#~ tsrs.SetFromUserInput(oprions.t_srs)</span>
        <span class="c">#~ if not epsg4326.IsSame(tsrs):</span>
            <span class="c">#~ logging.warning(&#39;KML format only supports &quot;EPSG:4326&quot; as &#39;</span>
                            <span class="c">#~ &#39;target spatial reference system: &#39;</span>
                            <span class="c">#~ &#39;&quot;t_srs&quot; parameter will be ignred.&#39;)</span>
            <span class="c">#~ options.t_srs = epsg4326</span>
        <span class="c">#~ else:</span>
            <span class="c">#~ options.t_srs = tsrs</span>

    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">args</span>

</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api/gsdtools.ras2vec.html#gsdtools.ras2vec.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(levelname)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
                        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">argv</span><span class="p">:</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

        <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">handlecmd</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;the output file (&quot;</span><span class="si">%s</span><span class="s">&quot;) already exists.&#39;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">EX_USAGE</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">create_datasource</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>    <span class="c"># , options.format)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">abspath</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">gcps</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">corners</span><span class="p">:</span>
                <span class="n">raster_index</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">gcps</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">compact_index</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputpath</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">abspath</span><span class="p">:</span>
                <span class="n">inputpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">inputpath</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">gcps</span><span class="p">:</span>
                <span class="n">gcplayer</span> <span class="o">=</span> <span class="s">&#39;GCPs&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gcplayer</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">inputpath</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">gcps</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">corners</span><span class="p">:</span>
                    <span class="n">boxlayer</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">boxlayer</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">inputpath</span><span class="p">))</span>
                <span class="n">raster_tree_index</span><span class="p">(</span><span class="n">inputpath</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span>
                                  <span class="n">boxlayer</span><span class="o">=</span><span class="n">boxlayer</span><span class="p">,</span> <span class="n">gcplayer</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">gcps</span><span class="p">,</span>
                                  <span class="n">mark_corners</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">export_raster</span><span class="p">(</span><span class="n">inputpath</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span>
                              <span class="n">boxlayer</span><span class="o">=</span><span class="s">&#39;box&#39;</span><span class="p">,</span> <span class="n">gcplayer</span><span class="o">=</span><span class="n">gcplayer</span><span class="p">,</span>
                              <span class="n">mark_corners</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
    
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
    
    
    <p>
        <a href="http://sourceforge.net/projects/gsdview">
            <img src="http://sflogo.sourceforge.net/sflogo.php?group_id=226458&type=14" width="150" height="40" alt="Get GSDView at SourceForge.net. Fast, secure and Free Open Source software downloads" />
        </a>
    </p>
    

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li><a href="../../index.html">GSDView</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-2011, Antonio Valentino.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>